#<-"/home/lkell/Desktop/Stuff/ICCAT/SCRS/2010/PerRecruit/Inputs/East_BFT/55-07 sh 075 4 blocks inflated CAA binary/BFTE2008.R1"
#<-"/home/lkell/Dropbox/ICCAT/GBYP-SAM/inputs/run_test_cpue/inputs_VPA/bfte2010.r1"
    
readVPA2BoxDiags<-function(x){

    tab5<-scan(x,what="",sep="\n")
    tab5<-tab5[grep("TABLE 5.",tab5): length(tab5)]

    pos  <-grep("Chi-sq. discrepancy=",tab5)
    nms  <-substr(tab5[pos-7],10,30)
    str  <-pos+5
    end  <-grep("Selectivities",tab5)-2

    fn<-function(uDiag) {
        uDiag<-unlist(strsplit(uDiag," "))
        as.numeric(uDiag[nchar(uDiag)>0])}

    uDiag<-tab5[unlist(mapply(seq,str,end))]
    dim1 <-length(uDiag)
    uDiag<-fn(uDiag)
    dim2 <-length(uDiag)
    nVar<-dim2/dim1
    uDiag<-as.data.frame(t(array(uDiag,c(nVar,length(uDiag)/nVar))))
    uDiag<-data.frame(cpue=unlist(mapply(rep, nms,(end-str)+1)),uDiag,row.names=NULL)

    #uDiag$cpue<-factor(uDiag$cpue)
    if (nVar==9) names(uDiag)<-c("cpue","year","obs","hat","rsdl","sd","q","obs2","hat2","chi2")
    if (nVar==7) names(uDiag)<-c("cpue","year","obs","hat","rsdl","sd","q","chi2")

    uDiag$rsdl2<-c(uDiag$rsdl[-1],NA)
    uDiag[!duplicated(uDiag[,"cpue"]),"rsdl2"]<-NA

    fnQQ<-function(object){
       qq.          =qqnorm(c(object$rsdl),plot.it=FALSE)
       qqx          =qq.$x
       qqy          =qq.$y

       res<-data.frame(qqx=qqx,qqy=qqy)

       return(res)}

    uDiag<-data.frame(uDiag,fnQQ(uDiag)[,c("qqx","qqy")])

    qqLine<-function(obj){
           x<-obj$qqx
           y<-obj$qqy

           qtlx<-quantile(x,prob=c(0.25,0.75),na.rm=T)
           qtly<-quantile(y,prob=c(0.25,0.75),na.rm=T)

           a=(qtly[1]-qtly[2])/(qtlx[1]-qtlx[2])
           b=qtly[1]-qtlx[1]*a

           res<-c(a,b)
           names(res)<-NULL
           names(res)<-c("a","b")

           return(res)
           return(data.frame(y=x*res["a"]+res["b"]))}

    par<-qqLine(uDiag)
    uDiag$qqYhat<-uDiag$qqx*par["a"]+par["b"]

    return(uDiag)}
  
file<-"/home/lkell/Dropbox/jrciccat/inputs/VPA2Box/BFT/bfte2010.d1"  

getPos<-function(file){
    lns   <-scan(file,what="",sep="\n")

    n     <-length(lns)
    minus1<-(1:n)[substr(lns,1,2)=="-1"]
    hash  <-(1:n)[substr(lns,1,1)=="#"]
    start <-c(hash[(hash[-1]-hash[-length(hash)])>1],hash[length(hash)])+1
    hash  <-rev(hash)
    end   <-c(rev(hash[hash[-length(hash)]-hash[-1]>1]-1),n)
    end[end %in% minus1]<-end[end %in% minus1]-1
    
    return(data.frame(start=start,end=end))}

getIdx<-function(x){
  posRng  <-1
  posSpc  <-5
  posIdx  <-6
  posVul  <-7
  posWaa  <-8
  
  # range
  t.        <-as.numeric(scan(x,skip=start[posRng]-1,nlines=end[posRng]-start[posRng]+1,what=character()))
  rng       <-t.[!is.na(t.)]
  names(rng)<-c("minyear","maxyear","min","max","plusgroup","pgproj")[1:length(rng)]
  
  # Specifications
  t.        <-as.numeric(scan(x,skip=start[posSpc]-1,nlines=end[posSpc]-start[posSpc]+1,what=character()))
  specs     <-t.[!is.na(t.)]
  specs     <-as.data.frame(t(array(specs,c(7,length(specs)/7))))
  names(specs)<-c("index","pdf","units","vul","timing","min","max")

  # index
  idx       <-as.numeric(scan(x,skip=start[indexPos]-1,nlines=end[indexPos]-start[indexPos]+1,what=character()))
  idx       <-idx[!is.na(idx)]
  n         <-length(idx)
  idx       <-as.data.frame(t(array(idx,dim=c(4,n/4))))
  names(idx)<-c("index","year","data","cv")

  # Vulnerabilities
  vul       <-as.numeric(scan(x,skip=start[posVul]-1,nlines=end[posVul]-start[posVul]+1,what=character()))
  vul       <-vul[!is.na(vul)]
  n         <-length(vul)
  nvar      <-diff(rng[c("min","max")])+3
  vul       <-as.data.frame(t(array(vul,dim=c(nvar,n/nvar))))  
  names(vul)[1:2]<-c("index","year")
  names(vul)[1:2]<-c("index","year")
  names(vul)[-(1:2)]<-seq(rng[c("min","max")])
  vul<-melt(vul,id=c("index","year"),variable="age")
  names(vul)[4]<-"data"

  # catch weight
  waa       <-as.numeric(scan(x,skip=start[posWaa]-1,nlines=end[posWaa]-start[posWaa]+1,what=character()))
  waa       <-waa[!is.na(waa)]
  n         <-length(waa)
  nvar      <-diff(rng[c("min","max")])+3
  waa       <-as.data.frame(t(array(waa,dim=c(nvar,n/nvar))))
  
  names(waa)[1:2]<-c("index","year")
  names(waa)[-(1:2)]<-seq(rng[c("min","max")])
  waa<-melt(waa,id=c("index","year"),variable="age")
  names(waa)[4]<-"data"

  return(list(range=rng,specs=specs,index=idx,vul=vul,waa=waa))} 


idxDat          <-getIdx(file)
idxDat$index.   <-dlply(idxDat$index,.(index),function(x) as.FLQuant(x[,c("year","data")]))
idxDat$index    <-idxDat$index[,c(1:2,4)]
names(idxDat$index)[3]<-"data"
idxDat$index.var<-dlply(idxDat$index,.(index),function(x) as.FLQuant(x[,c("year","data")]))
idxDat$vul      <-dlply(idxDat$vul,  .(index),function(x) as.FLQuant(x[,c("year","data")]))
idxDat$catch.wt <-dlply(idxDat$waa,  .(index),function(x) as.FLQuant(x[,c("age","year","data")]))

idx     <-FLIndices(mlply(unlist(idxDat$spec$index), function(x) 
                            FLIndex(type        =c("numbers","biomass")[1+idxDat$spec[x,"units"]],
                                    distribution=c("none","lognormal","normal")[1+idxDat$spec[x,"pdf"]],
                                    index       =idxDat$index.[[   x]],
                                    index.var   =idxDat$index.var[[x]]))),    
                                    catch.n     =FLQuant(NA),
                                    catch.wt    =FLQuant(NA),    
                                    effort      =FLQuant(NA),
                                    sel.pattern =FLQuant(NA),      
                                    index.q     =FLQuant(NA),
                                    name        =ac(x),  
                                    desc        ="read in from file")))
                                    
                                  #range       =unlist(idxDat$specs[x,c("min","max")]))))

 
dHeader<-list(
"################################################################################",
"###               INPUT FILE FOR PROGRAM VPA-2BOX, Version 2.0              ####",
"################################################################################",
"#  INSTRUCTIONS: the control options are entered in the order specified by     #",
"#                the existing comments.  The existing comment blocks may be    #",
"#                expanded to as many lines as desired, however new comment     #",
"#                lines may not be placed anywhere in the file other than       #",
"#                immediately before or immediately after existing comments.    #",
"#                All comment lines must have one of the following four symbols #",
"#                in the first column of the line:  #, !, *, or - .             #",
"#                Otherwise the line is perceived as free-format data input.    #",
"################################################################################")

"###############################################################################
"# BEGIN INPUT FOR AREA 1
"###############################################################################




"#________________________X______________________________________________________",
"# NOW ENTER THE CATCH-AT-AGE DATA. ROW=YEAR, COLUMN=AGE                         ",
"#_______________________________________________________________________________",




"-1 end of catch data                                                                ",
"#_______________________X___________________________________________________________",
"# NOW ENTER IN THE ABUNDANCE INDEX SPECIFICATIONS                                   ",
"#_______________________X___________________________________________________________",
"# GEAR or fishery type                                                              ",
"# |     PDF  (0= do not use,1=lognormal, 2=normal)                                  ",
"# |     |    UNITS (1 = numbers, 2 = biomass)                                       ",
"# |     |    |      SELECTIVITY (1 = fixed, 2 = fractional catches, 3 = Powers and Restrepo partial catches,4=Butterworth and Geromont eq 4)",
"# |     |    |      |     TIMING (-1 = AVERAGE DURING YEAR, POSITIVE INTEGER = NUMBER OF MONTHS ELAPSED)                                    ",
"# |     |    |      |     |       FIRST AGE  LAST AGE                                                                                       ",
"# |     |    |      |     |       |          |      TITLE (IN SINGLE QUOTES)                                                                ",
                                                                                                                                             ",
"-1 end index specifications                                                                                                                 ",
"#_______________________X___________________________________________________________                                                        ",
"# NOW ENTER IN THE INDICES OF ABUNDANCE                                                                                                     ",
"#________________________X___________________________________________________________                                                       ",


"-1 end index data                                                                   ",
"#_______________________X___________________________________________________________",
"# NOW ENTER IN THE SELECTIVITIES OR PARTIAL CATCHES FOR THE INDICES OF ABUNDANCE    ",
                                                                                     ",
"-1 -1 end index selectivities                                                       ",
"#______________________________________X_______________________________________     ",
"# NOW ENTER IN THE WEIGHTS AT AGE FOR THE INDICES OF ABUNDANCE (row=year, col=age)  ",
"#______________________________________X_______________________________________     ",
" -1                                                                                 ",
"#______________________________________X_______________________________________     ",
"# NOW ENTER IN THE WEIGHTS AT AGE FOR THE SPAWNING STOCK BIOMASS (row=year, col=age)",
"#______________________________________X_____________________________________       ",


################################################################################
## Paramter file                                                              ##
################################################################################

pHeader<-list(
"##############################################################################",
"###               INPUT FILE FOR PROGRAM VPA-2BOX, Version 2.0             ###",
"##############################################################################",
"#  INSTRUCTIONS: the control options are entered in the order specified by    ",
"#                the existing comments.  New comment                          ",
"#                lines may not be placed anywhere in the file other than      ",
"#                immediately before or immediately after existing comments.   ",
"#                All comment lines must have one of the following four symbols",
"#                in the first column of the line:  #, !, *, or - .            ",
"#                Otherwise the line is perceived as free-format data input.   ",
"#                                                                             ",
"#                The parameter specifications are input as follows:           ",
"#                a $ sign in the first column followed by an integer value (n)",
"#                tells the program that the next n parameters abide by these",
"#                same specifications. Thus                             ",
"#                                                                      ",
"#   column 1                                                           ",
"#   |   number of parameter to which these specifications apply        ",
"#   |   |    lower bound                                               ",
"#   |   |    |       best estimate (prior expectation)                 ",
"#   |   |    |       |       upper bound                               ",
"#   |   |    |       |       |       method of estimation              ",
"#   |   |    |       |       |       |      standard deviation of prior",
"#   $   5    0       1.2     2.0     1      0.1",
"#",
"#  The methods of estimation include:",
"#     0  fixed constant at value given for best estimate",
"#     1  estimate as a 'frequentist' parameter",
"#    -n  fix to the same value as parameter n (whether it is estimated or not)",
"#  -0.1  fix to the value of the previous estimated parameter",
"#   0.1  estimate as a random walk (a lognormal random deviation with given std. dev. and prior expectation equal to the previous parameter (whether estimated or not)",
"#   0.2  estimate as a lognormal random deviation with given std. dev. and prior expectation equal to the nearest previous constant or frequentist parameter)",
"#   0.3  estimate as a lognormal random deviation with given std. dev. and prior expectation equal to the input best estimate)",
"##############################################################################",
"#_________________ ____________________X_______________________________________",
"# TERMINAL F PARAMETERS: (lower bound, best estimate, upper bound, indicator, reference age)",
"# Note 1: the indicator for the terminal F parameters is unique in that if it is zero       ",
"#       but the best estimate is set to a value < 9, then the 'best estimate'               ",
"#       is perceived to be the selectivity relative to the reference age in the last        ",
"#       (fifth) column.  Otherwise these parameters are treated the same as the             ",
"#       others below and the fifth column is the standard deviation of the prior.           ",
"# Note 2: the last age is represented by an F-ratio parameter (below), so the number        ",
"#       of entries here should be 1 fewer than the number of ages                           ",
"#______________________________________X_______________________________________             ")


pPar<-c(
"#______________________________________X_______________________________________",
"# F-RATIO PARAMETERS F{oldest}/F{oldest-1} (lower bound, best estimate, upper bound, indicator, std. dev. of prior)",
"#   one parameter (set of specifications) for each year                                                            ",
"#______________________________________X_______________________________________                                    ",



"#_____________________________________X_______________________________________                                     ",
"# NATURAL MORTALITY PARAMETERS: (lower bound, best estimate, upper bound, indicator, std. dev. of prior)           ",
"#   one parameter (set of specifications) for each age                                                             ",
"#______________________________________X_______________________________________                                    ",


"#______________________________________X_______________________________________                                    ",
"# MIXING PARAMETERS: (lower bound, best estimate, upper bound, indicator, std. dev. of prior)                      ",
"#   one parameter (set of specifications) for each age                                                             ",
"#______________________________________X_______________________________________                                    ",


"#______________________________________X_______________________________________                                    ", 
"# STOCK-RECRUITMENT PARAMETERS: (lower bound, best estimate, upper bound, indicator, std. dev. of prior)           ",
"#   five parameters so 5 sets of specifications                                                                    ",
"#______________________________________X_______________________________________                                    ",


"#______________________________________X_______________________________________                                    ",
"# VARIANCE SCALING PARAMETER (lower bound, best estimate, upper bound, indicator, std. dev.)                       ",
"#   this parameter scales the input variance up or down as desired                                                 ",
"#   In principal, if you estimate this you should obtain more accurate estimates of the                            ",
"#   magnitude of the parameter variances-- all other things being equal.                                           ",
"#   (1 parameter so 1 set of specifications)                                                                       ",
"#______________________________________X_______________________________________                                    ",


pC<-c(
"#______________________________________X_______________________________________                                    ",
"# Catchability PARAMETERS F{oldest}/F{oldest-1} (same format as mixing parameters)                                 ",
"#       if drop an index and are estimating q's must change to not estimate for that index                         ",
"#______________________________________X_______________________________________                                    ",
"# index 1                                                                                                          ")

################################################################################                          ",
## Control file                                                               ##                          ",
################################################################################                          ",

"##############################################################################                                               ",
"###               CONTROL FILE FOR PROGRAM VPA-2BOX, Version 2.0           ###                                               ",
"##############################################################################                                               ",
"#  INSTRUCTIONS: the control options are entered in the order specified.                                                     ",
"#                Additional comment lines may be inserted anywhere in this                                                   ",
"#                file provided they are preceded by a # symbol in the FIRST                                                  ",
"#                column, otherwise the line is perceived as free-format data.                                                ",
"##############################################################################                                               ",
"#                                                                                                                            ",
"#############################################                                                                                ",
"# TITLES AND FILE NAMES (MUST BE PLACED WITHIN SINGLE QUOTES)                                                                ",
"#############################################                                                                                ",
"#|--------must be 50 characters or fewer----------|                                                                          ",
"'NORTHERN ALBACORE 1975-97'                                TITLE OF RUN                                                      ",
"'ALB00.d01'        DATA FILE NAME (INPUT)                                    ",
"'ALB00.p01'        PARAMETER SPECIFICATION FILE NAME (INPUT)                 ",
"'ALB00.r01'        RESULTS FILE NAME (OUTPUT)                                ",
"'ALB00.e01'        PARAMETER ESTIMATE FILE NAME (OUTPUT)                     ",
"'ALB00.SPD'        SPREADSHEET FRIENDLY RESULTS FILE NAME (OUTPUT)           ",
"'none for ALB '                                            TAGGING DATA FILE (INPUT)                                         ",
"#############################################                                                                                ",
"# MODEL TYPE OPTIONS                                                                                                         ",
"#############################################                                                                                ",
" 1                           NUMBER OF AREAS (1 OR 2)                                                                        ",
" 1                           MODEL_TYPE (1=SINGLE STOCK OR TWO-STOCK DIFFUSION, 2=TWO-STOCK OVERLAP)                                                                       ",
"#############################################                                                                                                                              ",
"# TAGGING DATA SWITCH                                                                                                                                                      ",
"#############################################                                                                                                                              ",
"# tagging data switch (0=do not use tagging data, 1=use tagging data)                                                                                                      ",
"# |  multiplicative weighting factor for modifying importance of tagging data in objective function (ignored if previous switch=0)                                         ",
"# |  |                                                                                                                                                                     ",
"  0  1.0   0 0 0 0 0 0 0 0 0 0 0 0       TAGGING MODEL CONTROLS (all irrelevant if switch set to 0)                                                                        ",
"#############################################                                                                                                                              ",
"# SEARCH ALGORITHM CONTROLS                                                                                                                                                ",
"#############################################                                                                                                                              ",
"-911                         RANDOM NUMBER SEED                                                                                                                            ",
" 20                          MAXIMUM NUMBER OF AMOEBA SIMPLEX SEARCH RESTARTS                                                                                              ",
" 3                           CHECKFLAG (convergence is declared when CHECKFLAG number of consecutive restarts result in parameter estimates that vary by less than 1%      ",
" .4                          PDEV (standard deviation controlling the random specification of vertices for the initial simplex of each restart)                            ",
"#############################################                                                                                                                              ",
"# INDEX WEIGHTING CONTROLS                                                                                                                                                 ",
"#############################################                                                                                                                              ",
" 0                           SCALE (DIVIDE INDEX VALUES BY THEIR MEAN)- ANY VALUE > 0 = YES                                                                                ",
" 1.0                         INDEX WEIGHTING OPTIONS:(0) INPUT CV's, (+) DEFAULT CV, (-) = DEFAULT STD. DEV., (999) so-called MAXIMUM LIKELIHOOD METHOD                    ",
" 0                           (0) MULTIPLICATIVE VARIANCE SCALING FACTOR or (1) ADDITIVE VARIANCE SCALING FACTOR                                                            ",
"#############################################                                                                                                                              ",
"# VARIOUS PENALTIES TO CONSTRAIN THE SOLUTION                                                                                                                              ",
"#############################################                                                                                                                              ",
"# apply this penalty to the last N years (SET N = 0 TO IGNORE)                                                                                                             ",
"# |  standard deviation controlling the severity of the penalty                                                                                                            ",
"# |  |  first age affected                                                                                                                                                 ",
"# |  |  |  last age affected                                                                                                                                               ",
"# |  |  |  |                                                                                                                                                               ",
"  0 .4  1  8    LINKS THE SELECTIVITIES IN THE LAST N YEARS                                                                                                                ",
"  0 .1          LINKS THE RECRUITMENTS IN THE LAST N YEARS                                                                                                                 ",
"  0 .1   1      LINKS THE RECRUITMENTS OF THE TWO STOCKS                                                                                                                   ",
"#        |                                                                                                                                                                 ",
"#        ratio of stock (sex) 1 to stock (sex) 2 {a value of 1 means a 1:1 ratio}                                                                                          ",
"#                                                                                                                                                                          ",
"# PDF of stock-recruit penalty {0=none, 1=lognormal, 2=normal (negative PDF tells program to estimate sigma by concentrated likelihood)}                                   ",
"# |  first and last years to use in fitting (in terms of recruits)                                                                                                         ",
"# |  |                                                                                                                                                                     ",
"  0  1975 1996      IMPOSES STOCK RECRUITMENT RELATIONSHIP (PENALIZES DEPARTURES FROM BEVERTON AND HOLT CURVE)                                                             ",
"#	             (note: check the parameter file to make sure you are estimating the S/R parameters when pdf not 0, or not estimating them when pdf=0))                      ",
"#############################################                                                                                                                              ",
"# PARAMETER ESTIMATION OPTIONS                                                                                                                                             ",
"#############################################                                                                                                                              ",
" 1              OPTION TO USE (1) F'S OR (2) N'S AS TERMINAL YEAR PARAMETERS                                                                                               ",
" -1             ESTIMATE Q IN (+) SEARCH or (<0) by concentrated MLE's                                                                                                     ",
"#############################################                                                                                                                              ",
"# BOOTSTRAP ANALYSES                                                                                                                                                       ",
"#############################################                                                                                                                              ",
"# Number of bootstraps to run (a negative value tells the program to do a parametric bootstrap)                                                                            ",
"# |     Use Stine correction to inflate bootstrap residuals (0=NO)                                                                                                         ",
"# |     |                                                                                                                                                                  ",
"  0   0           BOOTSTRAP OPTION                                                                                                                                         ",
"#############################################                                                                                                                              ",
"# RETROSPECTIVE ANALYSES (CANNOT DO RETROSPECTIVE ANALYSES AND BOOTSTRAPS AT SAME TIME)                                                                                    ",
"#############################################                                                                                                                              ",
" 0                NUMBER OF YEARS TO GO BACK FOR RETROSPECTIVE ANALYSES                                                                                                    ",
"#############################################                                                                                                                              ",
"# PRINTER CONTROL                                                                                                                                                          ",
"#############################################                                                                                                                              ",
" 84               INPUT ANY VALUE HERE, IT IS NOT YET BEING USED (printer lines per page for graphics -- a negative integer means no graphics}                             ",
"@EOF@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@")                                                                                                          ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",
                                                                                                                                                                            ",










