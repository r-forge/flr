### run using 2box files #############################################################################

## 1) Create dir and xaa files for running pro2box based on vpa   
#      p2bAdapt
## 1) Create dir and xaa files for running pro2box based on FLStock or FLAdapt   
#      p2bFLStock
## 2) Specify options for projections using ctl file
#      p2bCtl
## 3) Specify options for projections using files
#       p2bTxt
#    2.i   recruitment
#    2.ii  selection pattern
#    2.iii quotas
#    2.iv  wts


p2bAdapt=function(runs,from,to,exe){
  ## copies files from a vpa2box run to set up pro2box runs
  
  pths=apply(cbind(dir=to,run=runs),1, paste ,collapse="/")
  m_ply(pths,dir.create,recursive=T)
  
  m_ply(pths, function(to) file.copy(from=exe,to))
  
  m_ply(pths, function(to) file.copy(from=paste(from,"NAA.OUT",sep="/"),to))
  m_ply(pths, function(to) file.copy(from=paste(from,"FAA.OUT",sep="/"),to))
  m_ply(pths, function(to) file.copy(from=paste(from,"MAA.OUT",sep="/"),to))
  m_ply(pths, function(to) file.copy(from=paste(from,"CAA.OUT",sep="/"),to))
  m_ply(pths, function(to) file.copy(from=paste(from,"waa.txt",sep="/"),to))}

p2bFLStock=function(stk,dir,exe){
  ## sets up pro2box runs by creating dir with exe and data files generated from an FLStock
  
  dir.create(dir)
  
  file.copy(from=exe,dir)
  
  writeBin=function(flq,file,dir){
    res=t(flq[,,drop=T])
    
    writeBin(res, con=paste(dir,file,sep="/"), what=double(), size=4)}

  writeTxt=function(flq,dir,file){
    res=t(flq[,,drop=T])
    
    frstCols=switch(getFile(file), 
                    "naa.txt"=cbind(1,  as.numeric(dimnames(flq)$year)),
                    "faa.txt"=cbind(1,  as.numeric(dimnames(flq)$year)),
                    "caa.txt"=cbind(1,1,as.numeric(dimnames(flq)$year)),
                    "waa.txt"=cbind(1,0,as.numeric(dimnames(flq)$year)),
                    "maa.txt"=1)
    
    write.table(cbind(frstCols,res),file=paste(dir,file,sep="/"))}
  
  outFile=function(x,file,dir) if(tolower(getExt(file))=="txt") writeTxt(x,dir,file) else writeBin(x,dir,file)
  
  outFile(stock.n( stk),"naa.txt",dir)
  outFile(harvest( stk),"faa.txt",dir)
  outFile(catch.n( stk),"caa.txt",dir)
  outFile(catch.wt(stk),"waa.txt",dir)
  outFile(m(       stk),"maa.txt",dir)
  }

p2bCtl=function(ctl,dir){
  ## creates a control object
  
  cat(pro2boxComments()$header,     file=paste(dir,"/","pro2box.ctl",sep=""))
  cat("\n",file=paste(dir,"/","pro2box.ctl",sep=""),append=T)
  
  cat(paste(ctl@options,"\n"),file=paste(dir,"/","pro2box.ctl",sep=""),append=T)
  
  cat(pro2boxComments()$selectivity,file=paste(dir,"/","pro2box.ctl",sep=""),append=T)
  cat("\n",file=paste(dir,"/","pro2box.ctl",sep=""),append=T)
  }

p2bTxt=function(){}
  ## creates option files
  #  selection pattern

  #  quotas

  #  recruitment
  
  #  transfer coefs
  
  #  discards
  
  }


from="/home/laurie/Desktop/Dropbox/ICCAT/SCRS/BFT/2012/VPA/projections/Run_2/Reported/2012/med"
to  ="/home/laurie/Desktop/flr/tests/FLAdapt/pro2box/test"
exe ="/home/laurie/Desktop/flr/pkg/FLAdapt/inst/bin/linux/pro-2box"

runs=expand.grid(Run        ="Run_2",
                 catch      =c("Reported","Inflated"),
                 recruitment=c("low","med","high"),stringsAsFactors=F)

setRun(options,from,to,exe)


from       ="/home/laurie/Desktop/Dropbox/ICCAT/SCRS/BFT/2012/VPA/projections/Run_2/Reported/2012/low"

vpa        =readVpa2box(paste(from,"bfte2012.c1",sep="/"))
range(vpa)[c("min","max","plusgroup","minyear","maxyear")]


## create output dirs
pths=expand.grid(dir=dir,run=run,catch=catch,recruitment=recruitment,stringsAsFactors=F)

## copy from VPA dirs to output dirs
## i)   exe

## ii)  VPA files
## iii) projection options



           
#l_ply(comments,function(x) {cat(x);cat("\n")})