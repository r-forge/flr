# -*- Makefile -*-
#  $Id$
# PKG_CFLAGS=-Wunused -pedantic

FLCore_HOME=`Rscript -e 'cat(system.file("libs", package="FLCore"))'`

PKG_CPPFLAGS = -ggdb -I../inst/include
PKG_CFLAGS = -g -0 -I../inst/include
CXXFLAGS=-g -0

ADOLC_CXXFLAGS= -DHAVE_MALLOC=1 -DHAVE_REALLOC=1 -DADOLC_VERSION=1 -DADOLC_SUBVERSION=9 -DADOLC_PATCHLEVEL=0
ADOLC_CFLAGS= -DHAVE_MALLOC=1 -DHAVE_REALLOC=1 -DADOLC_VERSION=1 -DADOLC_SUBVERSION=9 -DADOLC_PATCHLEVEL=0

PKG_LIBS = $(SUBLIBS) $(FLCore_HOME)/FLCore.so

MkInclude = $(R_HOME)/etc${R_ARCH}/Makeconf

SOURCES_C = FLashDLL.cpp FLash-VPA.cpp flc.cpp flc_adolc.cpp flquant_pointer.cpp fwd.cpp fwdFLStock.cpp

OBJECTS = $(SOURCES_C:.cpp=.o)
SUBDIRS = adolc
SUBLIBS = $(SUBDIRS:=.a)

all: $(SHLIB)
## making src/*.o and in sublibs can be done simultaneously
$(SHLIB): $(OBJECTS) sublibs

## We have to clean here, to clean up between architectures:
## INSTALL only cleans src/*.o src/*$(SHLIB_EXT) for each arch
sublibs: subclean
	@for d in $(SUBDIRS); do \
	  (cd $${d} && CFLAGS="$(CFLAGS)" CXXFLAGS="$(CXXFLAGS)" MkInclude="$(MkInclude)" $(MAKE) library) || exit 1; \
	done

clean: subclean
	@-rm -rf .libs _libs
	@-rm -f *.o $(SHLIB)

subclean:
	@-rm -f *.a
	@for d in $(SUBDIRS); do \
	  (cd $${d} && MkInclude="$(MkInclude)" $(MAKE) clean) || exit 1; \
	done
